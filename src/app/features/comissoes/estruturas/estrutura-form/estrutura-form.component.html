<div class="kt-container-fluid">
    <!-- Page Header -->
    <div class="flex flex-wrap items-center justify-between gap-5 pb-5">
        <div class="flex flex-col gap-1">
            <h1 class="text-xl font-bold text-gray-900">
                @if (isEditMode()) {
                Editar Estrutura de Comissões
                } @else {
                Criar Estrutura de Comissões
                }
            </h1>
        </div>
        <div class="flex gap-3">
            <button type="button"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                (click)="cancel()">
                Cancelar
            </button>
            <button type="button"
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center"
                (click)="onSubmit()" [disabled]="saving() || loading()">
                @if (saving()) {
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                }
                Salvar Estrutura
            </button>
        </div>
    </div>

    <!-- Nome da Estrutura (Clean Input) -->
    <form [formGroup]="form">
        <div class="mb-8">
            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Nome da Estrutura de
                Comissão *</label>
            <input type="text" formControlName="nome"
                class="w-full px-0 py-2 border-0 border-b border-gray-200 text-lg font-medium text-gray-900 placeholder-gray-400 focus:ring-0 focus:border-blue-500 transition-colors bg-transparent"
                placeholder="Defina um nome para a estrutura" />
        </div>

        <!-- Comissão Total (O Bolo) -->
        <div class="mb-6 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
            <h3 class="text-sm font-bold text-blue-900 mb-4 flex items-center gap-2">
                <i class="ki-filled ki-chart-pie text-blue-600"></i>
                Comissão Total (O Bolo)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Tipo de Comissão -->
                <div class="flex flex-col gap-1.5">
                    <label class="text-xs font-medium text-gray-600 uppercase tracking-wide">Tipo de Comissão *</label>
                    <p-select formControlName="tipoComissao"
                        [options]="[{label: 'Percentual', value: 1}, {label: 'Valor Fixo', value: 2}]"
                        styleClass="w-full" placeholder="Selecione" appendTo="body" optionLabel="label"
                        optionValue="value"></p-select>
                </div>

                <!-- Valor da Comissão (condicional) -->
                <div class="flex flex-col gap-1.5">
                    @if (form.get('tipoComissao')?.value === TipoComissao.Percentual) {
                    <label class="text-xs font-medium text-gray-600 uppercase tracking-wide">Percentual da Comissão
                        *</label>
                    <p-inputNumber formControlName="valorComissao" [min]="0" [max]="100" suffix="%" styleClass="w-full"
                        inputStyleClass="w-full" placeholder="Ex: 5%" />
                    } @else {
                    <label class="text-xs font-medium text-gray-600 uppercase tracking-wide">Valor Fixo da Comissão
                        *</label>
                    <p-inputNumber formControlName="valorComissao" mode="currency" currency="BRL" locale="pt-BR"
                        styleClass="w-full" inputStyleClass="w-full" placeholder="R$ 0,00" />
                    }
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-3">
                <i class="ki-filled ki-information-2 text-blue-400 mr-1"></i>
                Define o valor total da comissão que será rateada entre os níveis hierárquicos abaixo.
            </p>
        </div>

        <!-- Geração Automática -->
        <div class="mb-6 p-4 bg-white rounded-xl border border-gray-200 flex items-center justify-between gap-4">
            <div class="flex flex-col gap-0.5">
                <span class="text-sm font-medium text-gray-900">Geração automática de comissão</span>
                <span class="text-xs text-gray-500">Quando ativada, a comissão será gerada automaticamente ao sincronizar vendas com esta estrutura vinculada.</span>
            </div>
            <p-checkbox formControlName="gerarAutomaticamente" [binary]="true" inputId="gerarAutomaticamente"></p-checkbox>
        </div>
    </form>
</div>

@if (loading()) {
<div class="kt-container-fluid">
    <div class="flex justify-center items-center py-20">
        <span class="animate-spin h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full"></span>
    </div>
</div>
} @else {
<div class="kt-container-fluid">
    <div class="grid grid-cols-12 gap-5">

        <!-- LEFT COLUMN: Níveis Hierárquicos -->
        <div class="col-span-12 lg:col-span-4 flex flex-col gap-5">
            <!-- Níveis Hierárquicos Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-5 py-4 flex items-center justify-between border-b border-gray-50">
                    <h3 class="font-semibold text-gray-900">Níveis Hierárquicos</h3>
                    <button type="button"
                        class="text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1 transition-colors"
                        (click)="addRootLevel()">
                        <i class="ki-filled ki-plus text-xs"></i>
                        <span>Adicionar nível</span>
                    </button>
                </div>

                <!-- Content -->
                <div class="p-5">
                    @if (treeData.length === 0) {
                    <div class="py-8 text-center">
                        <button type="button"
                            class="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1 mx-auto"
                            (click)="addRootLevel()">
                            <i class="ki-filled ki-plus text-xs"></i>
                            <span>Adicione o primeiro nível para começar</span>
                        </button>
                    </div>
                    } @else {
                    <div class="space-y-2">
                        <!-- Template recursivo para níveis ilimitados -->
                        <ng-template #levelTemplate let-nodes let-depth="depth">
                            @for (node of nodes; track node.key) {
                            <div class="group relative bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-300 transition-all hover:shadow-sm"
                                [class.bg-yellow-50]="node.type === 'bonus'"
                                [class.border-yellow-300]="node.type === 'bonus'"
                                [style.margin-left.px]="depth > 1 ? 16 : 0">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 cursor-pointer" (click)="editLevel(node)">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center"
                                            [class.bg-blue-100]="node.type !== 'bonus'"
                                            [class.bg-yellow-100]="node.type === 'bonus'">
                                            <i class="text-sm" [class.ki-filled]="true"
                                                [class.ki-people]="node.type !== 'bonus'"
                                                [class.ki-star]="node.type === 'bonus'"
                                                [class.text-blue-600]="node.type !== 'bonus'"
                                                [class.text-yellow-600]="node.type === 'bonus'"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium" [class.text-gray-900]="node.type !== 'bonus'"
                                                [class.text-yellow-700]="node.type === 'bonus'">{{ node.label }}</p>
                                            <p class="text-xs text-gray-500">
                                                @if (node.type === 'bonus') {
                                                Bônus por Performance · {{ node.data?.membros?.length || 0 }} membro(s)
                                                } @else {
                                                Nível Hierárquico {{ depth }} · {{ node.data?.membros?.length || 0 }}
                                                membro(s) ·
                                                {{ node.data.tipoValor === TipoValor.Percentual ? (node.data.percentual
                                                + '%') : 'R$ ' + node.data.valorFixo }}
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button type="button"
                                            class="w-6 h-6 flex items-center justify-center rounded hover:bg-green-100"
                                            (click)="$event.stopPropagation(); openBulkMemberDialog(node)"
                                            pTooltip="Adicionar Pessoas" tooltipPosition="top">
                                            <i class="ki-filled ki-user-square text-xs text-green-600"></i>
                                        </button>
                                        <button type="button"
                                            class="w-6 h-6 flex items-center justify-center rounded hover:bg-blue-100"
                                            (click)="$event.stopPropagation(); editLevel(node)" pTooltip="Editar"
                                            tooltipPosition="top">
                                            <i class="ki-filled ki-pencil text-xs text-blue-600"></i>
                                        </button>
                                        <button type="button"
                                            class="w-6 h-6 flex items-center justify-center rounded hover:bg-red-100"
                                            (click)="$event.stopPropagation(); deleteLevel(node)" pTooltip="Excluir"
                                            tooltipPosition="top">
                                            <i class="ki-filled ki-trash text-xs text-red-600"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            }
                        </ng-template>

                        <!-- Inicia a recursão com depth=1 -->
                        <ng-container
                            *ngTemplateOutlet="levelTemplate; context: { $implicit: treeData, depth: 1 }"></ng-container>
                    </div>
                    }
                </div>
            </div>

            <!-- Ações Rápidas Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h3 class="font-semibold text-gray-900 mb-4">Ações rápidas</h3>

                <button type="button"
                    class="w-full h-12 flex items-center gap-3 px-4 rounded-lg border border-dashed border-blue-200 bg-blue-50/50 hover:bg-blue-50 text-blue-700 transition-all group"
                    (click)="openMemberSelectionForAll()">
                    <div
                        class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
                        <i class="ki-filled ki-users text-sm"></i>
                    </div>
                    <span class="text-sm font-medium">Adicionar integrante ou equipe</span>
                </button>
            </div>
        </div>

        <!-- RIGHT COLUMN: Visual Tree -->
        <div class="col-span-12 lg:col-span-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 h-full p-0 overflow-hidden flex flex-col relative"
                style="min-height: 600px;">
                <app-hierarchy-tree [data]="orgData" (addSubordinates)="onAddSubordinatesFromTree($event)"
                    (addMembers)="onAddMembersFromTree($event)" (editNode)="onEditFromTree($event)"
                    (removeNode)="onRemoveFromTree($event)" class="w-full h-full block">
                </app-hierarchy-tree>
            </div>
        </div>

    </div>
</div>
}



<!-- Modal de Edição de Nível -->
<p-dialog [header]="editingNode ? 'Editar Nível: ' + editingNode.label : 'Novo Nível Hierárquico'"
    [(visible)]="displayLevelDialog" [modal]="true" [style]="{ width: '750px' }" [draggable]="false"
    [resizable]="false">
    <form [formGroup]="levelForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <!-- Row 1 -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Nome do nível hierárquico <span
                        class="text-red-500">*</span></label>
                <input type="text" pInputText formControlName="nomeNivel" class="w-full" placeholder="Escreva" />
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Nº de parcelas <span
                        class="text-red-500">*</span></label>
                <p-inputNumber formControlName="numeroParcelas" [min]="1" styleClass="w-full" inputStyleClass="w-full"
                    placeholder="Escreva" />
            </div>

            <!-- Row 2 -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Forma de cálculo <span
                        class="text-red-500">*</span></label>
                <p-select formControlName="tipoValor" [options]="tipoValorOptions" styleClass="w-full"
                    placeholder="Selecione" appendTo="body" optionLabel="label" optionValue="value"></p-select>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Valor ou percentual da Comissão <span
                        class="text-red-500">*</span></label>
                @if (levelForm.get('tipoValor')?.value === TipoValor.Percentual) {
                <p-inputNumber formControlName="percentual" [min]="0" [max]="100" suffix="%" styleClass="w-full"
                    inputStyleClass="w-full" placeholder="Escreva" />
                } @else if (levelForm.get('tipoValor')?.value === TipoValor.Fixo) {
                <p-inputNumber formControlName="valorFixo" mode="currency" currency="BRL" locale="pt-BR"
                    styleClass="w-full" inputStyleClass="w-full" placeholder="R$ 0,00" />
                } @else {
                <input type="text" pInputText disabled class="w-full" placeholder="Selecione a forma de cálculo" />
                }
            </div>

            <!-- Row 3: Tipo de Comissão e Bônus -->
            <div class="col-span-1 md:col-span-2 flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Tipo de Comissão <span
                        class="text-red-500">*</span></label>
                <p-select formControlName="tipoComissao" [options]="tipoComissaoOptions" styleClass="w-full"
                    placeholder="Selecione" appendTo="body" optionLabel="label" optionValue="value"></p-select>
            </div>

            <!-- Campos de Bônus (Visíveis para qualquer tipo de bônus: 4, 5, 6) -->
            @if (levelForm.get('tipoComissao')?.value >= TipoComissao.BonusPorPercentual) {
            <div class="col-span-1 md:col-span-2 p-4 bg-yellow-50 rounded-lg border border-yellow-200 mt-2">
                <h4 class="text-sm font-bold text-yellow-800 mb-4 flex items-center gap-2">
                    <i class="ki-filled ki-star"></i> Configuração do Bônus
                </h4>
                <div class="flex flex-col gap-6">
                    <!-- Origem de Pagamento -->
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-gray-700">Origem do Pagamento <span
                                    class="text-red-500">*</span></label>
                            <button type="button" (click)="router.navigate(['/bonificacao/origem-pagamento'])"
                                class="text-xs font-semibold text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                <i class="ki-filled ki-setting-2"></i> Gerenciar
                            </button>
                        </div>
                        <p-select formControlName="origemPagamentoId" [options]="origensPagamento" styleClass="w-full"
                            placeholder="Selecione a origem" appendTo="body" [filter]="true" filterBy="label"
                            optionLabel="label" optionValue="value">
                            <ng-template pTemplate="empty">
                                <div class="p-3 text-center">
                                    <p class="text-sm text-gray-500 mb-2">Nenhuma origem cadastrada para esta empresa.
                                    </p>
                                    <button type="button" pButton label="Cadastrar agora" icon="ki-filled ki-plus"
                                        class="p-button-sm p-button-outlined"
                                        (click)="router.navigate(['/bonificacao/origem-pagamento'])"></button>
                                </div>
                            </ng-template>
                        </p-select>
                        <small class="text-gray-500 text-xs">A origem define qual fundo ou empresa pagará este
                            bônus.</small>
                    </div>

                    <!-- Campo Condicional: Meta de Vendas (apenas para BonusMeta = 6) -->
                    @if (levelForm.get('tipoComissao')?.value == TipoComissao.BonusMeta) {
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Meta de Vendas Mínima (R$) <span
                                class="text-red-500">*</span></label>
                        <p-inputNumber formControlName="metaVendasMinima" mode="currency" currency="BRL" locale="pt-BR"
                            styleClass="w-full" inputStyleClass="w-full" placeholder="R$ 0,00" />
                        <small class="text-gray-500">Valor mínimo em vendas para liberar o bônus.</small>
                    </div>
                    }

                    <!-- Campo Condicional: Parcela Inicial (apenas para BonusPorPercentual = 4) -->
                    @if (levelForm.get('tipoComissao')?.value == TipoComissao.BonusPorPercentual) {
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Parcela Inicial para Liberação <span
                                class="text-red-500">*</span></label>
                        <p-inputNumber formControlName="parcelaInicialLiberacao" [min]="1" styleClass="w-full"
                            inputStyleClass="w-full" placeholder="Ex: 1" />
                        <small class="text-gray-500 text-xs">A partir de qual parcela paga o bônus começa a ser
                            liberado.</small>
                    </div>

                    <div class="flex items-center gap-2">
                        <p-checkbox formControlName="liberacaoAutomaticaQuitacao" [binary]="true"
                            inputId="libAuto"></p-checkbox>
                        <label for="libAuto" class="text-sm text-gray-700 cursor-pointer">Liberar automaticamente na
                            quitação antecipada</label>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Row 4 -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Tipo de liberação <span
                        class="text-red-500">*</span></label>
                <p-select formControlName="regraLiberacao" [options]="regraLiberacaoOptions" styleClass="w-full"
                    placeholder="Selecione" appendTo="body" optionLabel="label" optionValue="value"></p-select>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Prioridade de pagamento <span
                        class="text-red-500">*</span></label>
                <!-- Using placeholder items for Prioridade since it is new/unmapped -->
                <p-select formControlName="prioridade"
                    [options]="[{label: 'Alta', value: 1}, {label: 'Normal', value: 2}, {label: 'Baixa', value: 3}]"
                    styleClass="w-full" placeholder="Selecione" appendTo="body" optionLabel="label" optionValue="value">
                </p-select>
            </div>
        </div>

        <!-- Members Section REMOVED to align with Figma 'Clean' design -->
    </form>

    <ng-template pTemplate="footer">
        <div class="flex gap-2 justify-end pt-4 border-t border-gray-100">
            <button type="button"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors"
                (click)="displayLevelDialog = false">
                Cancelar
            </button>
            <button type="button"
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                (click)="saveLevel()">
                {{ editingNode ? 'Salvar' : 'Criar' }}
            </button>
        </div>
    </ng-template>
</p-dialog>


<!-- Bulk Member Dialog -->
<p-dialog [(visible)]="displayBulkMemberDialog" [modal]="true" [style]="{width: '600px'}"
    [header]="'Adicionar integrantes em massa'" styleClass="p-fluid">

    <div class="mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-blue-50/50 p-4 rounded-lg border border-blue-100">
            <div class="flex flex-col gap-2">
                <label class="text-xs font-semibold uppercase text-gray-500 tracking-wide">Nível Hierárquico <span
                        class="text-red-500">*</span></label>
                <p-select [options]="treeData" [(ngModel)]="parentForNewNode" optionLabel="label" styleClass="w-full"
                    placeholder="Selecione o Nível" appendTo="body">
                </p-select>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-xs font-semibold uppercase text-gray-500 tracking-wide">Respondendo Para (Gestor
                    Direto)</label>
                <p-select [options]="membrosDisponiveisParaGestor" [(ngModel)]="membroGestorIdForNewMember"
                    optionLabel="label" optionValue="value" styleClass="w-full" placeholder="Selecione (Opcional)"
                    [showClear]="true" appendTo="body" [filter]="true" filterBy="label">
                </p-select>
                <small class="text-gray-500 text-xs">Define a posição no organograma.</small>
            </div>
        </div>

        <p class="text-sm font-semibold text-gray-700 mb-3">Pesquisar e Selecionar Integrantes</p>

        <div class="flex gap-2 mb-4">
            <span class="p-input-icon-left flex-1">
                <i class="ki-filled ki-magnifier"></i>
                <input type="text" pInputText [(ngModel)]="bulkMemberSearch" (ngModelChange)="filterMembersForBulk()"
                    placeholder="Buscar por nome ou CRECI" />
            </span>
            <div class="flex border rounded-lg overflow-hidden">
                <button type="button" class="px-3 py-2 text-sm font-medium transition-colors"
                    [class.bg-blue-50]="selectedBulkMemberType === 'usuario'"
                    [class.text-blue-600]="selectedBulkMemberType === 'usuario'"
                    [class.bg-white]="selectedBulkMemberType !== 'usuario'"
                    [class.text-gray-600]="selectedBulkMemberType !== 'usuario'"
                    (click)="selectedBulkMemberType = 'usuario'; filterMembersForBulk()">
                    Usuários
                </button>
                <button type="button" class="px-3 py-2 text-sm font-medium transition-colors border-l"
                    [class.bg-blue-50]="selectedBulkMemberType === 'equipe'"
                    [class.text-blue-600]="selectedBulkMemberType === 'equipe'"
                    [class.bg-white]="selectedBulkMemberType !== 'equipe'"
                    [class.text-gray-600]="selectedBulkMemberType !== 'equipe'"
                    (click)="selectedBulkMemberType = 'equipe'; filterMembersForBulk()">
                    Equipes
                </button>
            </div>
        </div>

        <div class="flex items-center justify-between mb-2 gap-2">
            <button type="button"
                class="px-3 py-1.5 text-sm font-medium rounded-lg transition-colors flex items-center gap-2"
                [class.bg-blue-600]="selectedMembersForBulk.length < filteredMembersForBulk.length"
                [class.text-white]="selectedMembersForBulk.length < filteredMembersForBulk.length"
                [class.hover:bg-blue-700]="selectedMembersForBulk.length < filteredMembersForBulk.length"
                [class.bg-gray-100]="selectedMembersForBulk.length === filteredMembersForBulk.length"
                [class.text-gray-700]="selectedMembersForBulk.length === filteredMembersForBulk.length"
                [class.hover:bg-gray-200]="selectedMembersForBulk.length === filteredMembersForBulk.length"
                (click)="toggleAllBulkMembers()">
                <i class="ki-filled"
                    [class.ki-check-square]="selectedMembersForBulk.length === filteredMembersForBulk.length"
                    [class.ki-add-item]="selectedMembersForBulk.length < filteredMembersForBulk.length"></i>
                {{ selectedMembersForBulk.length === filteredMembersForBulk.length ? 'Desmarcar todos' : 'Selecionar
                todos (' + filteredMembersForBulk.length + ')' }}
            </button>
            <span class="text-sm text-gray-500">{{ selectedMembersForBulk.length }} selecionados</span>
        </div>

        <div class="h-[300px] overflow-y-auto border rounded-lg divide-y bg-gray-50">
            @if (selectedBulkMemberType === 'usuario') {
            <div class="divide-y divide-gray-100">
                @for (group of groupedMembersForBulk; track group.name) {
                <!-- Team Header -->
                <div class="bg-white px-3 py-2 border-b border-gray-50 sticky top-0 z-10">
                    <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider">{{ group.name }}</h5>
                </div>

                <!-- Members in Team -->
                @for (member of group.members; track member.id) {
                <div class="p-3 hover:bg-blue-50 cursor-pointer flex items-center gap-3 transition-colors pl-6"
                    [class.bg-blue-50]="isBulkMemberSelected(member)" (click)="toggleBulkMemberSelection(member)">
                    <div class="w-5 h-5 rounded border flex items-center justify-center transition-colors"
                        [class.bg-blue-600]="isBulkMemberSelected(member)"
                        [class.border-blue-600]="isBulkMemberSelected(member)"
                        [class.border-gray-300]="!isBulkMemberSelected(member)"
                        [class.bg-white]="!isBulkMemberSelected(member)">
                        @if (isBulkMemberSelected(member)) {
                        <i class="ki-filled ki-check text-white text-xs"></i>
                        }
                    </div>
                    <!-- <p-checkbox [binary]="true" [ngModel]="isBulkMemberSelected(member)" [ngModelOptions]="{standalone: true}"
                    (click)="$event.stopPropagation()" (onChange)="toggleBulkMemberSelection(member)">
                </p-checkbox> -->
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ member.nome }}</p>
                    </div>
                </div>
                }
                }
            </div>
            } @else {
            <!-- Flat List for Teams (legacy/fallback) -->
            <div class="divide-y divide-gray-100">
                @for (member of filteredMembersForBulk; track member.id) {
                <div class="p-3 hover:bg-blue-50 cursor-pointer flex items-center gap-3 transition-colors"
                    [class.bg-blue-50]="isBulkMemberSelected(member)" (click)="toggleBulkMemberSelection(member)">
                    <div class="w-5 h-5 rounded border flex items-center justify-center transition-colors"
                        [class.bg-blue-600]="isBulkMemberSelected(member)"
                        [class.border-blue-600]="isBulkMemberSelected(member)"
                        [class.border-gray-300]="!isBulkMemberSelected(member)"
                        [class.bg-white]="!isBulkMemberSelected(member)">
                        @if (isBulkMemberSelected(member)) {
                        <i class="ki-filled ki-check text-white text-xs"></i>
                        }
                    </div>
                    <!-- <p-checkbox [binary]="true" [ngModel]="isBulkMemberSelected(member)" [ngModelOptions]="{standalone: true}"
                    (click)="$event.stopPropagation()" (onChange)="toggleBulkMemberSelection(member)">
                </p-checkbox> -->
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ member.nome }}</p>
                        @if (isTeam(member)) {
                        <p class="text-xs text-gray-500">Equipe</p>
                        }
                    </div>
                </div>
                }
            </div>
            }
            @if (filteredMembersForBulk.length === 0) {
            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                <i class="ki-filled ki-search text-2xl mb-2"></i>
                <p class="text-sm">Nenhum resultado encontrado</p>
            </div>
            }
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <button pButton label="Cancelar" class="p-button-text text-gray-600"
                (click)="displayBulkMemberDialog = false"></button>
            <button pButton
                [label]="'Vincular ' + (selectedMembersForBulk.length > 0 ? selectedMembersForBulk.length + ' Pessoas' : '')"
                class="bg-blue-600 border-none" (click)="saveBulkMembers()"
                [disabled]="selectedMembersForBulk.length === 0"></button>
        </div>
    </ng-template>
</p-dialog>