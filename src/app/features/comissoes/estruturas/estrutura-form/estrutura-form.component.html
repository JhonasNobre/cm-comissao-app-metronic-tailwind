<div class="kt-container-fluid">
    <!-- Page Header -->
    <div class="flex flex-wrap items-center justify-between gap-5 pb-5">
        <div class="flex flex-col gap-1">
            <h1 class="text-2xl font-semibold text-blue-600">
                @if (isEditMode()) {
                Editar Estrutura de Comissões
                } @else {
                Criar Estrutura de Comissões
                }
            </h1>
        </div>
        <div class="flex gap-3">
            <button type="button" class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium"
                (click)="cancel()">
                Cancelar
            </button>
            <button type="button" class="px-6 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 font-medium"
                (click)="onSubmit()" [disabled]="saving() || loading()">
                @if (saving()) {
                <span
                    class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2 inline-block"></span>
                }
                Salvar Estrutura
            </button>
        </div>
    </div>

    <!-- Nome da Estrutura (Top Field) -->
    <form [formGroup]="form">
        <div class="mb-5">
            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Estrutura de Comissão *</label>
            <input type="text" formControlName="nome"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Defina um nome" />
        </div>
    </form>
</div>

@if (loading()) {
<div class="kt-container-fluid">
    <div class="flex justify-center items-center py-20">
        <span class="animate-spin h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full"></span>
    </div>
</div>
} @else {
<div class="kt-container-fluid">
    <div class="grid grid-cols-12 gap-5">

        <!-- LEFT COLUMN: Níveis Hierárquicos -->
        <div class="col-span-12 lg:col-span-4">
            <div class="bg-white rounded-lg border border-gray-200">
                <!-- Header -->
                <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-base font-semibold text-gray-900">Níveis Hierárquicos</h3>
                    <button type="button" class="flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700"
                        (click)="addRootLevel()">
                        <i class="ki-filled ki-plus text-xs"></i>
                        <span>Adicionar nível</span>
                    </button>
                </div>

                <!-- Content -->
                <div class="p-5">
                    @if (treeData.length === 0) {
                    <div class="py-8 text-center">
                        <button type="button"
                            class="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1 mx-auto"
                            (click)="addRootLevel()">
                            <i class="ki-filled ki-plus text-xs"></i>
                            <span>Adicione o primeiro nível para começar</span>
                        </button>
                    </div>
                    } @else {
                    <div class="space-y-2">
                        @for (node of treeData; track node.key) {
                        <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50"
                            [class.bg-yellow-50]="node.type === 'bonus'"
                            [class.border-yellow-300]="node.type === 'bonus'">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 cursor-pointer" (click)="editLevel(node)">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                                        [class.bg-blue-100]="node.type !== 'bonus'"
                                        [class.bg-yellow-100]="node.type === 'bonus'">
                                        <i class="text-sm" [class.ki-filled]="true"
                                            [class.ki-people]="node.type !== 'bonus'"
                                            [class.ki-star]="node.type === 'bonus'"
                                            [class.text-blue-600]="node.type !== 'bonus'"
                                            [class.text-yellow-600]="node.type === 'bonus'"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">{{ node.label }}</p>
                                        <p class="text-xs text-gray-500">
                                            {{ node.data?.membros?.length || 0 }} membro(s) ·
                                            {{ node.data.tipoValor === TipoValor.Percentual ? (node.data.percentual +
                                            '%') : 'R$ ' + node.data.valorFixo }}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button type="button"
                                        class="w-6 h-6 flex items-center justify-center rounded hover:bg-blue-100"
                                        (click)="$event.stopPropagation(); editLevel(node)" pTooltip="Editar"
                                        tooltipPosition="top">
                                        <i class="ki-filled ki-pencil text-xs text-blue-600"></i>
                                    </button>
                                    <button type="button"
                                        class="w-6 h-6 flex items-center justify-center rounded hover:bg-red-100"
                                        (click)="$event.stopPropagation(); deleteLevel(node)" pTooltip="Excluir"
                                        tooltipPosition="top">
                                        <i class="ki-filled ki-trash text-xs text-red-600"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Show children levels indented -->
                            @if (node.children && node.children.length > 0) {
                            <div class="ml-6 mt-2 space-y-2 border-l-2 border-gray-200 pl-3">
                                @for (child of node.children; track child.key) {
                                <div class="border border-gray-200 rounded-lg p-2 hover:bg-gray-50 flex items-center justify-between"
                                    [class.bg-yellow-50]="child.type === 'bonus'">
                                    <div class="flex items-center gap-2 cursor-pointer" (click)="editLevel(child)">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                                            <i class="ki-filled ki-people text-xs text-blue-600"></i>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-900">{{ child.label }}</p>
                                            <p class="text-xs text-gray-500">{{ child.data?.membros?.length || 0 }}
                                                membro(s)</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button type="button"
                                            class="w-5 h-5 flex items-center justify-center rounded hover:bg-blue-100"
                                            (click)="$event.stopPropagation(); editLevel(child)">
                                            <i class="ki-filled ki-pencil text-xs text-blue-600"></i>
                                        </button>
                                        <button type="button"
                                            class="w-5 h-5 flex items-center justify-center rounded hover:bg-red-100"
                                            (click)="$event.stopPropagation(); deleteLevel(child)">
                                            <i class="ki-filled ki-trash text-xs text-red-600"></i>
                                        </button>
                                    </div>
                                </div>
                                }
                            </div>
                            }
                            <!-- Add child level button -->
                            <button type="button"
                                class="text-blue-600 hover:text-blue-700 text-xs flex items-center gap-1 mt-2"
                                (click)="$event.stopPropagation(); addChildLevel(node)">
                                <i class="ki-filled ki-plus text-xs"></i>
                                <span>Adicionar subnível</span>
                            </button>
                        </div>
                        }

                        <!-- Ações rápidas -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Ações rápidas</h4>
                            <button type="button"
                                class="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1"
                                (click)="openMemberSelectionForAll()">
                                <i class="ki-filled ki-plus text-xs"></i>
                                <span>Adicionar integrante ou equipe</span>
                            </button>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- MIDDLE COLUMN: Integrante Card -->
        <div class="col-span-12 lg:col-span-4">
            <div class="bg-white rounded-lg border border-gray-200 p-5">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i class="ki-filled ki-people text-lg text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-base font-semibold text-gray-900">Integrantes</h3>
                            <p class="text-sm text-gray-500">Membros da estrutura</p>
                            <p class="text-xs text-gray-400 flex items-center gap-1 mt-1">
                                <i class="ki-filled ki-people text-xs"></i>
                                <span>{{ getTotalMembersCount() }} pessoa(s)</span>
                            </p>
                        </div>
                    </div>
                    <button type="button"
                        class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center hover:bg-blue-700"
                        (click)="openMemberSelectionForAll()" pTooltip="Adicionar membros em massa">
                        <i class="ki-filled ki-plus text-white text-sm"></i>
                    </button>
                </div>

                <!-- Quick member preview -->
                @if (getTotalMembersCount() > 0) {
                <div class="border-t border-gray-200 pt-4">
                    <p class="text-xs text-gray-500 mb-2">Últimos adicionados:</p>
                    <div class="flex flex-wrap gap-2">
                        @for (member of getAllMembersPreview(); track $index) {
                        <div class="flex items-center gap-1 bg-gray-100 rounded-full px-2 py-1">
                            <span
                                class="w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center text-xs text-white">
                                {{ member.nome?.charAt(0) || 'U' }}
                            </span>
                            <span class="text-xs text-gray-700">{{ member.nome }}</span>
                        </div>
                        }
                        @if (getTotalMembersCount() > 5) {
                        <span class="text-xs text-gray-500 px-2 py-1">+{{ getTotalMembersCount() - 5 }} mais</span>
                        }
                    </div>
                </div>
                }
            </div>
        </div>

        <!-- RIGHT COLUMN: Summary Card -->
        <div class="col-span-12 lg:col-span-4">
            <div class="bg-white rounded-lg border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Resumo da Estrutura</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Total de Níveis:</span>
                        <span class="text-sm font-medium text-gray-900">{{ countAllLevels() }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Total de Membros:</span>
                        <span class="text-sm font-medium text-gray-900">{{ getTotalMembersCount() }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Tipo de Comissão:</span>
                        <span class="text-sm font-medium text-gray-900">{{ getTipoComissaoLabel() }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Tipo de Rateio:</span>
                        <span class="text-sm font-medium text-gray-900">{{ getTipoRateioLabel() }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- FULL WIDTH: Form Fields (Below the 3 columns) -->
        <div class="col-span-12 mt-5">
            <form [formGroup]="form">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-5 pb-4 border-b border-gray-200">Configurações
                        da
                        Estrutura</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Descrição</label>
                            <input type="text" pInputText formControlName="descricao" class="w-full"
                                placeholder="Descrição opcional" />
                        </div>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Tipo de Comissão *</label>
                            <p-select formControlName="tipoComissao" [options]="tipoComissaoOptions"
                                placeholder="Selecione o tipo" styleClass="w-full" />
                        </div>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Tipo de Rateio *</label>
                            <p-select formControlName="tipoRateio" [options]="tipoRateioOptions"
                                placeholder="Selecione o rateio" styleClass="w-full" />
                        </div>

                        @if (form.get('tipoComissao')?.value === TipoComissao.Percentual ||
                        form.get('tipoComissao')?.value === TipoComissao.Misto) {
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Percentual Base (%) *</label>
                            <p-inputNumber formControlName="valorPercentual" [min]="0" [max]="100"
                                [minFractionDigits]="2" [maxFractionDigits]="2" suffix="%" styleClass="w-full"
                                inputStyleClass="w-full" />
                        </div>
                        }

                        @if (form.get('tipoComissao')?.value === TipoComissao.ValorFixo ||
                        form.get('tipoComissao')?.value === TipoComissao.Misto) {
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Valor Fixo Base *</label>
                            <p-inputNumber formControlName="valorFixoInicial" mode="currency" currency="BRL"
                                locale="pt-BR" [min]="0" styleClass="w-full" inputStyleClass="w-full" />
                        </div>
                        }

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Regra de Liberação *</label>
                            <p-select formControlName="regraLiberacao" [options]="regraLiberacaoOptions"
                                placeholder="Selecione a regra" styleClass="w-full" />
                        </div>

                        @if (form.get('regraLiberacao')?.value === RegraLiberacao.PercentualPago) {
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Percentual para Liberação (%) *</label>
                            <p-inputNumber formControlName="percentualLiberacao" [min]="0" [max]="100" suffix="%"
                                styleClass="w-full" inputStyleClass="w-full" />
                        </div>
                        }

                        @if (form.get('regraLiberacao')?.value === RegraLiberacao.ParcelasPagas) {
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Parcela para Liberação *</label>
                            <p-inputNumber formControlName="parcelaLiberacao" [min]="1" styleClass="w-full"
                                inputStyleClass="w-full" />
                        </div>
                        }
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
}

<!-- Modal de Adição em Massa -->
<p-dialog header="Adicionar integrantes em massa" [(visible)]="displayBulkMemberDialog" [modal]="true"
    [style]="{ width: '600px' }" [draggable]="false" [resizable]="false">

    <p class="text-sm text-gray-600 mb-1">Selecione os membros para atribuir a todos os níveis hierárquicos</p>
    <p class="text-xs text-gray-500 mb-4">Busca por NOME ou CNPJ</p>

    <!-- Search Bar -->
    <div class="mb-3">
        <input type="text" pInputText [(ngModel)]="bulkMemberSearch" (ngModelChange)="filterMembersForBulk()"
            class="w-full" placeholder="Busca Global" />
    </div>

    <!-- Select All Link -->
    <div class="mb-3">
        <a href="javascript:void(0)" class="text-blue-600 hover:underline text-sm" (click)="selectAllMembers()">
            Selecionar todos ({{ filteredMembersForBulk.length }})
        </a>
    </div>

    <!-- Member List -->
    <div class="max-h-[400px] overflow-y-auto border rounded-lg">
        @if (filteredMembersForBulk.length === 0) {
        <div class="p-8 text-center text-gray-500">
            <p class="text-sm">Nenhum membro encontrado</p>
        </div>
        } @else {
        <div class="divide-y">
            @for (member of filteredMembersForBulk; track member.id) {
            <div class="p-3 hover:bg-gray-50 cursor-pointer flex items-center gap-3"
                (click)="toggleMemberSelection(member)">
                <p-checkbox [binary]="true" [ngModel]="isMemberSelected(member)" [ngModelOptions]="{standalone: true}"
                    (click)="$event.stopPropagation()">
                </p-checkbox>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">{{ member.nome }}</p>
                </div>
            </div>
            }
        </div>
        }
    </div>

    <ng-template pTemplate="footer">
        <div class="flex gap-2 justify-end">
            <button pButton label="Cancelar" class="p-button-text p-button-secondary"
                (click)="displayBulkMemberDialog = false"></button>
            <button pButton
                [label]="'Vincular ' + selectedMembersForBulk.length + (selectedMembersForBulk.length === 1 ? ' Pessoa' : ' Pessoas')"
                class="p-button" [disabled]="selectedMembersForBulk.length === 0"
                (click)="confirmBulkAssignment()"></button>
        </div>
    </ng-template>
</p-dialog>

<!-- Modal de Edição de Nível -->
<p-dialog [header]="editingNode ? 'Editar Nível: ' + editingNode.label : 'Novo Nível Hierárquico'"
    [(visible)]="displayLevelDialog" [modal]="true" [style]="{ width: '750px' }" [draggable]="false"
    [resizable]="false">
    <form [formGroup]="levelForm">
        <div class="grid grid-cols-2 gap-4">
            <!-- Row 1 -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Nome do nível hierárquico <span
                        class="text-red-500">*</span></label>
                <input type="text" pInputText formControlName="nomeNivel" class="w-full"
                    placeholder="Ex: Gerente de Vendas" />
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Nº de parcelas <span
                        class="text-red-500">*</span></label>
                <p-inputNumber formControlName="prioridade" [min]="1" styleClass="w-full" inputStyleClass="w-full"
                    placeholder="1" />
            </div>

            <!-- Row 2 -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Forma de cálculo <span
                        class="text-red-500">*</span></label>
                <p-select formControlName="tipoValor" [options]="tipoValorOptions" styleClass="w-full"
                    placeholder="Selecione" appendTo="body"></p-select>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Valor ou percentual da Comissão <span
                        class="text-red-500">*</span></label>
                @if (levelForm.get('tipoValor')?.value === TipoValor.Percentual) {
                <p-inputNumber formControlName="percentual" [min]="0" [max]="100" suffix="%" styleClass="w-full"
                    inputStyleClass="w-full" placeholder="10" />
                } @else if (levelForm.get('tipoValor')?.value === TipoValor.Fixo) {
                <p-inputNumber formControlName="valorFixo" mode="currency" currency="BRL" locale="pt-BR"
                    styleClass="w-full" inputStyleClass="w-full" placeholder="R$ 1.000,00" />
                } @else {
                <input type="text" pInputText disabled class="w-full"
                    placeholder="Selecione a forma de cálculo primeiro" />
                }
            </div>

            <!-- Row 3: Tipo de Comissão -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Tipo de Comissão</label>
                <p-select [options]="tipoComissaoOptions" styleClass="w-full" placeholder="Selecione"
                    appendTo="body"></p-select>
            </div>

            <!-- Row 4 -->
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-gray-700">Tipo de liberação</label>
                <p-select [options]="regraLiberacaoOptions" styleClass="w-full" placeholder="Selecione"
                    appendTo="body"></p-select>
            </div>
        </div>

        <!-- Members Section -->
        <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-sm font-semibold text-gray-900">Membros deste Nível ({{ currentLevelMembers.length }})
                </h4>
                <button type="button" class="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1"
                    (click)="showMemberSearch = !showMemberSearch">
                    <i class="ki-filled ki-plus text-xs"></i>
                    <span>Adicionar membro</span>
                </button>
            </div>

            <!-- Search member -->
            @if (showMemberSearch) {
            <div class="flex gap-2 mb-4">
                <p-selectButton [options]="memberTypeOptions" [(ngModel)]="selectedMemberType"
                    [ngModelOptions]="{standalone: true}" styleClass="flex-shrink-0"></p-selectButton>
                <p-autoComplete [(ngModel)]="selectedMemberToAdd" [ngModelOptions]="{standalone: true}"
                    [suggestions]="selectedMemberType === 'usuario' ? filteredUsers : filteredTeams"
                    (completeMethod)="searchMembers($event)" field="nome" placeholder="Buscar por nome..."
                    styleClass="w-full" inputStyleClass="w-full"></p-autoComplete>
                <button pButton type="button" icon="pi pi-plus" class="p-button-sm" (click)="addToMemberList()"
                    [disabled]="!selectedMemberToAdd"></button>
            </div>
            }

            <!-- Member list -->
            @if (currentLevelMembers.length > 0) {
            <div class="space-y-2 max-h-40 overflow-y-auto">
                @for (member of currentLevelMembers; track member.id; let i = $index) {
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                            <span class="text-xs font-medium text-blue-600">{{ member.nome?.charAt(0) || 'U' }}</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ member.nome }}</p>
                            <p class="text-xs text-gray-500">{{ member.usuarioId ? 'Usuário' : 'Equipe' }}</p>
                        </div>
                    </div>
                    <button type="button" class="text-red-600 hover:text-red-700" (click)="removeFromMemberList(i)">
                        <i class="ki-filled ki-trash text-sm"></i>
                    </button>
                </div>
                }
            </div>
            } @else {
            <p class="text-sm text-gray-500 text-center py-4">Nenhum membro adicionado a este nível</p>
            }
        </div>
    </form>

    <ng-template pTemplate="footer">
        <div class="flex gap-2 justify-end">
            <button pButton label="Cancelar" class="p-button-text p-button-secondary"
                (click)="displayLevelDialog = false"></button>
            <button pButton [label]="editingNode ? 'Salvar' : 'Criar'" class="p-button" (click)="saveLevel()"></button>
        </div>
    </ng-template>
</p-dialog>

<p-toast />