<div class="kt-container-fluid">
    <div class="flex flex-col gap-5 pb-5">

        <!-- Header & Breadcrumbs -->
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-gray-900">Comissões</h1>
                <div class="text-sm text-gray-500">Dashboard / Listagem</div>
            </div>

            <button pButton label="Exportar relatório" icon="pi pi-download"
                class="p-button-primary p-button-sm"></button>
        </div>

        <!-- Custom Tabs -->
        <div class="flex border-b border-gray-200">
            <button class="px-4 py-2 font-medium text-sm border-b-2 transition-colors duration-200 focus:outline-none"
                [ngClass]="activeTab === 'historico' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'"
                (click)="setActiveTab('historico')">
                Histórico
            </button>
            <button class="px-4 py-2 font-medium text-sm border-b-2 transition-colors duration-200 focus:outline-none"
                [ngClass]="activeTab === 'pendentes' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'"
                (click)="setActiveTab('pendentes')">
                Comissões Pendentes
            </button>
        </div>

        <!-- Filters (Simplificado) -->
        <div class="card p-4 flex flex-wrap gap-4 items-center">
            <div class="flex-1 min-w-[300px]">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Buscar por imóvel, cliente ou corretor..."
                        class="w-full p-inputtext-sm" />
                </span>
            </div>
            <!-- Outros filtros dropdowns mocks -->
            <div class="flex gap-2">
                <button pButton label="Produto: Todos" class="p-button-text p-button-secondary p-button-sm"></button>
                <button pButton label="Cidade: Todas" class="p-button-text p-button-secondary p-button-sm"></button>
                <button pButton label="Status: Todos" class="p-button-text p-button-secondary p-button-sm"></button>
            </div>
        </div>

    </div>
</div>

<div class="kt-container-fluid">
    <div class="card-body pt-0">

        <!-- Tabela Histórico -->
        <app-generic-p-table *ngIf="activeTab === 'historico'" [tableData]="historico"
            [columnDefinition]="columnsHistorico" [totalRecords]="totalRecordsHistorico" [serverSidePagination]="true"
            [rows]="10" [displayCreateAction]="false" [displayDetailAction]="false"
            (lazyLoad)="onLazyLoadHistorico($event)">
        </app-generic-p-table>

        <!-- Tabela Pendentes -->
        <div *ngIf="activeTab === 'pendentes'">
            <!-- Botão Liberar em Lote -->
            <div class="mb-3 flex justify-between items-center" *ngIf="selectedParcelas && selectedParcelas.length > 0">
                <div class="text-sm text-gray-600">
                    {{selectedParcelas.length}} parcela(s) selecionada(s)
                </div>
                <button pButton label="Liberar Comissão" 
                        icon="pi pi-check" 
                        class="p-button-success p-button-sm"
                        (click)="onLiberarLote()"
                        [disabled]="saving">
                </button>
            </div>

            <app-generic-p-table 
                [tableData]="pendentes"
                [columnDefinition]="columnsPendentes" 
                [totalRecords]="totalRecordsPendentes" 
                [serverSidePagination]="true"
                [rows]="10" 
                [displayCreateAction]="false" 
                [displayDetailAction]="false"
                [(selection)]="selectedParcelas"
                [selectionMode]="'multiple'"
                (lazyLoad)="onLazyLoadPendentes($event)">
                
                <!-- Custom Actions Column -->
                <ng-template pTemplate="body" let-rowData let-columns="columns">
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
                        </td>
                        <td *ngFor="let col of columns">
                            <ng-container [ngSwitch]="col.displayAs">
                                <p-badge *ngSwitchCase="'badge'" 
                                         [value]="rowData[col.field]" 
                                         [severity]="col.badgeSeverityMap?.[rowData[col.field]] || 'info'">
                                </p-badge>
                                <span *ngSwitchDefault>{{ rowData[col.field] }}</span>
                            </ng-container>
                        </td>
                        <td>
                            <button pButton 
                                    type="button" 
                                    icon="pi pi-ellipsis-v" 
                                    class="p-button-rounded p-button-text p-button-sm"
                                    (click)="menu.toggle($event); parcelaEmAcao = rowData">
                            </button>
                        </td>
                    </tr>
                </ng-template>
            </app-generic-p-table>
        </div>

    </div>
</div>

<!-- Menu de Ações -->
<p-menu #menu [popup]="true" [model]="[
    {
        label: 'Bloquear Comissão',
        icon: 'pi pi-lock',
        command: () => onBloquearParcela(parcelaEmAcao)
    },
    {
        label: 'Liberar Comissão',
        icon: 'pi pi-unlock',
        command: () => onLiberarParcela(parcelaEmAcao)
    },
    {
        label: 'Cancelar Comissão',
        icon: 'pi pi-times',
        command: () => onCancelarParcela(parcelaEmAcao),
        styleClass: 'text-red-500'
    }
]"></p-menu>

<p-confirmDialog [style]="{width: '450px'}" rejectButtonStyleClass="p-button-text"></p-confirmDialog>
<p-toast></p-toast>