<div class="kt-container-fluid">
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {{ isEditMode ? 'Editar Usuário' : 'Novo Usuário' }}
            </h1>
        </div>
    </div>
</div>

<div class="kt-container-fluid">
    <div class="grid gap-5 lg:gap-7.5">
        <div class="kt-card">
            <div class="kt-card-body">
                <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-5">
                    <p-toast></p-toast>

                    <!-- Dados Básicos -->
                    <div class="flex flex-col gap-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Dados Básicos</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Nome Completo</label>
                                <input type="text" pInputText formControlName="nomeCompleto" class="w-full"
                                    placeholder="Nome Completo" />
                                <small *ngIf="form.get('nomeCompleto')?.invalid && form.get('nomeCompleto')?.touched"
                                    class="text-red-500">
                                    Nome é obrigatório.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">CPF</label>
                                <p-inputMask mask="999.999.999-99" formControlName="cpf" placeholder="000.000.000-00"
                                    styleClass="w-full"></p-inputMask>
                                <small *ngIf="form.get('cpf')?.invalid && form.get('cpf')?.touched"
                                    class="text-red-500">
                                    CPF é obrigatório.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Email</label>
                                <input type="email" pInputText formControlName="email" class="w-full"
                                    placeholder="email@exemplo.com" />
                                <small *ngIf="form.get('email')?.invalid && form.get('email')?.touched"
                                    class="text-red-500">
                                    Email inválido ou obrigatório.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Telefone</label>
                                <p-inputMask mask="(99) 99999-9999" formControlName="telefone"
                                    placeholder="(00) 00000-0000" styleClass="w-full"></p-inputMask>
                                <small *ngIf="form.get('telefone')?.invalid && form.get('telefone')?.touched"
                                    class="text-red-500">
                                    Telefone é obrigatório.
                                </small>
                            </div>

                            <div *ngIf="!isEditMode" class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Senha</label>
                                <p-password formControlName="senha" [toggleMask]="true" [feedback]="true"
                                    styleClass="w-full" inputStyleClass="w-full"></p-password>
                                <small *ngIf="form.get('senha')?.invalid && form.get('senha')?.touched"
                                    class="text-red-500">
                                    Senha deve ter no mínimo 8 caracteres.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Permissões e Acesso -->
                    <div class="flex flex-col gap-4 mt-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Permissões e Acesso</h3>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Imobiliária</label>
                                <p-select formControlName="idEmpresa" [options]="companies" optionLabel="nome"
                                    optionValue="id" placeholder="Selecione uma imobiliária" [style]="{'width':'100%'}"
                                    appendTo="body" [filter]="true" filterBy="nome" [showClear]="true">
                                </p-select>
                                <small class="text-red-500"
                                    *ngIf="form.get('idEmpresa')?.invalid && form.get('idEmpresa')?.touched">
                                    A imobiliária é obrigatória
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Tipo de Usuário</label>
                                <p-select [options]="userRoleOptions" formControlName="tipoUsuario" optionLabel="label"
                                    optionValue="value" styleClass="w-full" [style]="{'width':'100%'}"
                                    appendTo="body"></p-select>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700">Role (Keycloak)</label>
                                <div class="p-3 bg-gray-100 rounded border border-gray-300 text-gray-600">
                                    {{ getRoleLabel(form.get('role')?.value) || 'Sem role definida' }}
                                </div>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700">Perfil de Acesso</label>
                                <p-select [options]="accessProfiles" formControlName="perfilAcessoId" optionLabel="nome"
                                    optionValue="id" placeholder="Selecione um perfil" styleClass="w-full"
                                    [style]="{'width':'100%'}" appendTo="body" [showClear]="true"></p-select>
                            </div>
                        </div>
                    </div>

                    <!-- Equipes -->
                    <div class="flex flex-col gap-4 mt-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Equipes</h3>

                        <div class="flex flex-col gap-2">
                            <label class="font-semibold text-gray-700">Selecione as Equipes</label>

                            <!-- Select simples (1 equipe) para usuários regulares -->
                            <p-select *ngIf="!isManager" [options]="teams" formControlName="equipeIds"
                                optionLabel="nome" optionValue="id" placeholder="Selecione uma equipe"
                                styleClass="w-full" [style]="{'width':'100%'}" appendTo="body"
                                [showClear]="true"></p-select>

                            <!-- MultiSelect (N equipes) para gestores/admins -->
                            <p-multiSelect *ngIf="isManager" [options]="teams" formControlName="equipeIds"
                                optionLabel="nome" optionValue="id" placeholder="Selecione as equipes"
                                styleClass="w-full" [style]="{'width':'100%'}" appendTo="body" [showClear]="true"
                                display="chip"></p-multiSelect>
                        </div>
                    </div>

                    <!-- Restrição de Horário -->
                    <div class="flex flex-col gap-4 mt-2">
                        <div class="flex items-center gap-2 border-b pb-2">
                            <p-checkbox [binary]="true" inputId="restricao" [ngModel]="hasRestricaoHorario"
                                (onChange)="toggleRestricaoHorario($event)"
                                [ngModelOptions]="{standalone: true}"></p-checkbox>
                            <label for="restricao"
                                class="text-lg font-semibold text-gray-800 cursor-pointer select-none"
                                (click)="hasRestricaoHorario = !hasRestricaoHorario; toggleRestricaoHorario({checked: hasRestricaoHorario})">
                                Restrição de Horário
                            </label>
                        </div>

                        <div *ngIf="hasRestricaoHorario" formGroupName="restricaoHorario"
                            class="flex flex-col gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">

                            <!-- Bloqueio em Feriados -->
                            <div class="flex items-center gap-2">
                                <p-checkbox formControlName="bloquearEmFeriadosNacionais" [binary]="true"
                                    inputId="feriados"></p-checkbox>
                                <label for="feriados" class="cursor-pointer select-none">Bloquear em Feriados
                                    Nacionais</label>
                            </div>

                            <!-- UF e Código IBGE -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex flex-col gap-2">
                                    <label for="uf" class="text-sm font-medium text-gray-600">UF Feriados</label>
                                    <input pInputText id="uf" formControlName="ufFeriados" placeholder="Ex: SP"
                                        maxlength="2" class="w-full" />
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="ibge" class="text-sm font-medium text-gray-600">Cód. IBGE
                                        Município</label>
                                    <input pInputText id="ibge" formControlName="codigoIbgeMunicipio"
                                        placeholder="Ex: 3550308" class="w-full" />
                                </div>
                            </div>

                            <!-- Lista de Horários -->
                            <div class="flex flex-col gap-3 mt-2">
                                <div class="flex justify-between items-center">
                                    <label class="font-semibold text-gray-700">Horários Permitidos</label>
                                    <button type="button" class="kt-btn kt-btn-sm kt-btn-light-primary"
                                        (click)="addHorario()">
                                        <i class="ki-filled ki-plus"></i>
                                        Adicionar Horário
                                    </button>
                                </div>

                                <div formArrayName="horarios" class="flex flex-col gap-3">
                                    <div *ngFor="let item of horarios.controls; let i = index" [formGroupName]="i"
                                        class="flex flex-wrap md:flex-nowrap gap-2 items-end bg-white p-3 rounded border border-gray-200 shadow-sm">

                                        <!-- Dia da Semana -->
                                        <div class="w-full md:flex-1">
                                            <label class="text-xs text-gray-500 block mb-1">Dia da Semana</label>
                                            <p-select [options]="diasSemanaOptions" formControlName="diaSemana"
                                                optionLabel="label" optionValue="value" styleClass="w-full"
                                                [style]="{'width':'100%'}" appendTo="body"></p-select>
                                        </div>

                                        <!-- Hora Início -->
                                        <div class="w-1/2 md:w-28">
                                            <label class="text-xs text-gray-500 block mb-1">Início</label>
                                            <p-inputMask mask="99:99" formControlName="horaInicio" placeholder="08:00"
                                                styleClass="w-full"></p-inputMask>
                                        </div>

                                        <!-- Hora Fim -->
                                        <div class="w-1/2 md:w-28">
                                            <label class="text-xs text-gray-500 block mb-1">Fim</label>
                                            <p-inputMask mask="99:99" formControlName="horaFim" placeholder="18:00"
                                                styleClass="w-full"></p-inputMask>
                                        </div>

                                        <!-- Botão Remover -->
                                        <button type="button" class="btn btn-icon btn-light-danger" pTooltip="Remover"
                                            tooltipPosition="top" (click)="removeHorario(i)">
                                            <i class="ki-filled ki-trash"></i>
                                        </button>
                                    </div>

                                    <div *ngIf="horarios.controls.length === 0"
                                        class="text-center p-4 text-gray-500 text-sm italic">
                                        Nenhum horário configurado. Adicione um horário para permitir acesso.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="flex justify-end gap-3 pt-5 mt-4 border-t border-gray-200">
                        <button *ngIf="isEditMode && !isInactive && !isProtected" type="button"
                            class="kt-btn kt-btn-danger mr-auto" (click)="onInactivate()">
                            <i class="ki-filled ki-cross-circle"></i>
                            Inativar Usuário
                        </button>

                        <button *ngIf="isEditMode && isInactive" type="button" class="kt-btn kt-btn-success mr-auto"
                            (click)="onReactivate()">
                            <i class="ki-filled ki-check-circle"></i>
                            Habilitar Usuário
                        </button>

                        <button type="button" class="kt-btn kt-btn-light" (click)="onCancel()">
                            Cancelar
                        </button>
                        <button type="submit" class="kt-btn kt-btn-primary" [disabled]="form.invalid || loading">
                            <i *ngIf="!loading" class="ki-filled ki-check"></i>
                            <span *ngIf="loading"
                                class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>