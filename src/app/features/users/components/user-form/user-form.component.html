<div class="kt-container-fluid">
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {{ isEditMode ? 'Editar Usu√°rio' : 'Novo Usu√°rio' }}
            </h1>
        </div>
    </div>
</div>

<div class="kt-container-fluid">
    <div class="grid gap-5 lg:gap-7.5">
        <div class="kt-card">
            <div class="kt-card-body">
                <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-5">
                    <p-toast></p-toast>

                    <!-- Dados B√°sicos -->
                    <div class="flex flex-col gap-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Dados B√°sicos</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Nome Completo</label>
                                <input type="text" pInputText formControlName="nomeCompleto" class="w-full"
                                    placeholder="Nome Completo" />
                                <small *ngIf="form.get('nomeCompleto')?.invalid && form.get('nomeCompleto')?.touched"
                                    class="text-red-500">
                                    Nome √© obrigat√≥rio.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">CPF</label>
                                <p-inputMask mask="999.999.999-99" formControlName="cpf" placeholder="000.000.000-00"
                                    styleClass="w-full"></p-inputMask>
                                <small *ngIf="form.get('cpf')?.invalid && form.get('cpf')?.touched"
                                    class="text-red-500">
                                    CPF √© obrigat√≥rio.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Email</label>
                                <input type="email" pInputText formControlName="email" class="w-full"
                                    placeholder="email@exemplo.com" />
                                <small *ngIf="form.get('email')?.invalid && form.get('email')?.touched"
                                    class="text-red-500">
                                    Email inv√°lido ou obrigat√≥rio.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Telefone</label>
                                <p-inputMask mask="(99) 99999-9999" formControlName="telefone"
                                    placeholder="(00) 00000-0000" styleClass="w-full"></p-inputMask>
                                <small *ngIf="form.get('telefone')?.invalid && form.get('telefone')?.touched"
                                    class="text-red-500">
                                    Telefone √© obrigat√≥rio.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700">Chave Pix</label>
                                <input type="text" pInputText formControlName="chavePix" class="w-full"
                                    placeholder="CPF, E-mail, Telefone ou Aleat√≥ria" />
                            </div>

                            <div *ngIf="!isEditMode" class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700 required">Senha</label>
                                <p-password formControlName="senha" [toggleMask]="true" [feedback]="true"
                                    styleClass="w-full" inputStyleClass="w-full"></p-password>
                                <small *ngIf="form.get('senha')?.invalid && form.get('senha')?.touched"
                                    class="text-red-500">
                                    Senha deve ter no m√≠nimo 8 caracteres.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Permiss√µes e Acesso -->
                    <div class="flex flex-col gap-4 mt-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Permiss√µes e Acesso</h3>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">




                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700">Perfis de Acesso</label>
                                <p-multiSelect [options]="accessProfiles" formControlName="perfilAcessoIds"
                                    optionLabel="nome" optionValue="id" placeholder="Selecione os perfis"
                                    [style]="{'width':'100%'}" appendTo="body" [showClear]="true"
                                    display="chip"></p-multiSelect>
                            </div>
                        </div>
                    </div>

                    <!-- Equipes -->
                    <div class="flex flex-col gap-4 mt-2">
                        <div class="flex justify-between items-center border-b pb-2">
                            <h3 class="text-lg font-semibold text-gray-800">Equipes</h3>
                            <button type="button" class="kt-btn kt-btn-sm kt-btn-light-primary" (click)="addEquipe()">
                                <i class="ki-filled ki-plus"></i>
                                Adicionar Equipe
                            </button>
                        </div>

                        <div formArrayName="equipes" class="flex flex-col gap-3">
                            <div *ngFor="let item of equipes.controls; let i = index" [formGroupName]="i"
                                class="flex flex-wrap md:flex-nowrap gap-2 items-end bg-white p-3 rounded border border-gray-200 shadow-sm">

                                <!-- Equipe -->
                                <div class="w-full md:flex-1">
                                    <label class="text-xs text-gray-500 block mb-1">Equipe</label>
                                    <p-select [options]="teams" formControlName="equipeId" optionLabel="nome"
                                        optionValue="id" placeholder="Selecione a equipe" styleClass="w-full"
                                        [style]="{'width':'100%'}" appendTo="body"
                                        (onChange)="onTeamSelectionChange(i)"></p-select>
                                </div>

                                <!-- Grupo -->
                                <div class="w-full md:flex-1">
                                    <label class="text-xs text-gray-500 block mb-1">Grupo</label>
                                    <p-select [options]="rowGroupOptions[i] || []" formControlName="grupoEquipeId"
                                        optionLabel="label" optionValue="value" placeholder="Selecione o grupo"
                                        styleClass="w-full" [style]="{'width':'100%'}" appendTo="body"
                                        [showClear]="true"></p-select>
                                </div>

                                <!-- Bot√£o Remover -->
                                <button type="button" class="btn btn-icon btn-light-danger" pTooltip="Remover"
                                    tooltipPosition="top" (click)="removeEquipe(i)">
                                    <i class="ki-filled ki-trash"></i>
                                </button>
                            </div>

                            <div *ngIf="equipes.controls.length === 0"
                                class="text-center p-4 text-gray-500 text-sm italic">
                                Nenhuma equipe vinculada. Adicione uma equipe.
                            </div>
                        </div>
                    </div>

                    <!-- Al√ßadas Individuais (Novo) -->
                    <div class="flex flex-col gap-4 mt-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">üéØ Al√ßadas Individuais</h3>
                        <p class="text-sm text-gray-600">
                            Defina limites espec√≠ficos para este usu√°rio. Estes valores <strong>sobrescrevem</strong> os
                            limites do Perfil de Acesso.
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700">Limite de Desconto M√°ximo (%)</label>
                                <input type="number" pInputText formControlName="limiteDescontoMaximoIndividual"
                                    class="w-full" placeholder="Ex: 15.5" step="0.01" min="0" max="100" />
                                <small class="text-gray-500"
                                    *ngIf="!form.get('limiteDescontoMaximoIndividual')?.invalid">
                                    Deixe vazio para usar o limite do perfil
                                </small>
                                <small class="text-red-500"
                                    *ngIf="form.get('limiteDescontoMaximoIndividual')?.hasError('max')">
                                    O valor m√°ximo permitido √© 100%.
                                </small>
                                <small class="text-red-500"
                                    *ngIf="form.get('limiteDescontoMaximoIndividual')?.hasError('min')">
                                    O valor n√£o pode ser negativo.
                                </small>
                            </div>

                            <div class="flex flex-col gap-2">
                                <label class="font-semibold text-gray-700">Quantidade M√°xima de Reservas</label>
                                <input type="number" pInputText formControlName="quantidadeMaximaReservasIndividual"
                                    class="w-full" placeholder="Ex: 5" min="0" />
                                <small class="text-gray-500"
                                    *ngIf="!form.get('quantidadeMaximaReservasIndividual')?.invalid">
                                    Deixe vazio para usar o limite do perfil
                                </small>
                                <small class="text-red-500"
                                    *ngIf="form.get('quantidadeMaximaReservasIndividual')?.hasError('min')">
                                    A quantidade n√£o pode ser negativa.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Permiss√µes Individuais (Tabela) -->
                    <div class="flex flex-col gap-4 mt-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">üîê Permiss√µes Individuais</h3>
                        <p class="text-sm text-gray-600">
                            Defina permiss√µes espec√≠ficas para este usu√°rio. Estas permiss√µes
                            <strong>sobrescrevem</strong> as permiss√µes do Perfil de Acesso.
                        </p>

                        <p-table [value]="permissionRows" [table Style]="{ 'min-width': '50rem' }"
                            styleClass="p-datatable-sm">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Recurso</th>
                                    <th class="text-center">Criar</th>
                                    <th class="text-center">Ler</th>
                                    <th class="text-center">Atualizar</th>
                                    <th class="text-center">Excluir</th>
                                    <th>Escopo</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-row>
                                <tr>
                                    <td>{{ row.recursoNome }}</td>
                                    <td class="text-center">
                                        <p-checkbox [(ngModel)]="row.canCreate" [binary]="true"
                                            [ngModelOptions]="{standalone: true}"></p-checkbox>
                                    </td>
                                    <td class="text-center">
                                        <p-checkbox [(ngModel)]="row.canRead" [binary]="true"
                                            [ngModelOptions]="{standalone: true}"></p-checkbox>
                                    </td>
                                    <td class="text-center">
                                        <p-checkbox [(ngModel)]="row.canUpdate" [binary]="true"
                                            [ngModelOptions]="{standalone: true}"></p-checkbox>
                                    </td>
                                    <td class="text-center">
                                        <p-checkbox [(ngModel)]="row.canDelete" [binary]="true"
                                            [ngModelOptions]="{standalone: true}"></p-checkbox>
                                    </td>
                                    <td>
                                        <p-select [options]="scopeOptions" [(ngModel)]="row.scope" optionLabel="label"
                                            optionValue="value" [ngModelOptions]="{standalone: true}"
                                            styleClass="w-full" [style]="{'width':'100%'}" appendTo="body"></p-select>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>

                    <!-- Restri√ß√£o de Hor√°rio -->
                    <div class="flex flex-col gap-4 mt-2">
                        <div class="flex items-center gap-2 border-b pb-2">
                            <p-checkbox [binary]="true" inputId="restricao" [ngModel]="hasRestricaoHorario"
                                (onChange)="toggleRestricaoHorario($event)"
                                [ngModelOptions]="{standalone: true}"></p-checkbox>
                            <label for="restricao"
                                class="text-lg font-semibold text-gray-800 cursor-pointer select-none"
                                (click)="hasRestricaoHorario = !hasRestricaoHorario; toggleRestricaoHorario({checked: hasRestricaoHorario})">
                                Restri√ß√£o de Hor√°rio
                            </label>
                        </div>

                        <div *ngIf="hasRestricaoHorario" formGroupName="restricaoHorario"
                            class="flex flex-col gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">

                            <!-- Bloqueio em Feriados -->
                            <div class="flex items-center gap-2">
                                <p-checkbox formControlName="bloquearEmFeriadosNacionais" [binary]="true"
                                    inputId="feriados"></p-checkbox>
                                <label for="feriados" class="cursor-pointer select-none">Bloquear em Feriados
                                    Nacionais</label>
                            </div>

                            <!-- UF e C√≥digo IBGE -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex flex-col gap-2">
                                    <label for="uf" class="text-sm font-medium text-gray-600">UF Feriados</label>
                                    <input pInputText id="uf" formControlName="ufFeriados" placeholder="Ex: SP"
                                        maxlength="2" class="w-full" />
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="ibge" class="text-sm font-medium text-gray-600">C√≥d. IBGE
                                        Munic√≠pio</label>
                                    <input pInputText id="ibge" formControlName="codigoIbgeMunicipio"
                                        placeholder="Ex: 3550308" class="w-full" />
                                </div>
                            </div>

                            <!-- Lista de Hor√°rios -->
                            <div class="flex flex-col gap-3 mt-2">
                                <div class="flex justify-between items-center">
                                    <label class="font-semibold text-gray-700">Hor√°rios Permitidos</label>
                                    <button type="button" class="kt-btn kt-btn-sm kt-btn-light-primary"
                                        (click)="addHorario()">
                                        <i class="ki-filled ki-plus"></i>
                                        Adicionar Hor√°rio
                                    </button>
                                </div>

                                <div formArrayName="horarios" class="flex flex-col gap-3">
                                    <div *ngFor="let item of horarios.controls; let i = index" [formGroupName]="i"
                                        class="flex flex-wrap md:flex-nowrap gap-2 items-end bg-white p-3 rounded border border-gray-200 shadow-sm">

                                        <!-- Dia da Semana -->
                                        <div class="w-full md:flex-1">
                                            <label class="text-xs text-gray-500 block mb-1">Dia da Semana</label>
                                            <p-select [options]="diasSemanaOptions" formControlName="diaSemana"
                                                optionLabel="label" optionValue="value" styleClass="w-full"
                                                [style]="{'width':'100%'}" appendTo="body"></p-select>
                                        </div>

                                        <!-- Hora In√≠cio -->
                                        <div class="w-1/2 md:w-28">
                                            <label class="text-xs text-gray-500 block mb-1">In√≠cio</label>
                                            <p-inputMask mask="99:99" formControlName="horaInicio" placeholder="08:00"
                                                styleClass="w-full"></p-inputMask>
                                        </div>

                                        <!-- Hora Fim -->
                                        <div class="w-1/2 md:w-28">
                                            <label class="text-xs text-gray-500 block mb-1">Fim</label>
                                            <p-inputMask mask="99:99" formControlName="horaFim" placeholder="18:00"
                                                styleClass="w-full"></p-inputMask>
                                        </div>

                                        <!-- Bot√£o Remover -->
                                        <button type="button" class="btn btn-icon btn-light-danger" pTooltip="Remover"
                                            tooltipPosition="top" (click)="removeHorario(i)">
                                            <i class="ki-filled ki-trash"></i>
                                        </button>
                                    </div>

                                    <div *ngIf="horarios.controls.length === 0"
                                        class="text-center p-4 text-gray-500 text-sm italic">
                                        Nenhum hor√°rio configurado. Adicione um hor√°rio para permitir acesso.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- A√ß√µes -->
                    <div class="flex justify-end gap-3 pt-5 mt-4 border-t border-gray-200">
                        <button *ngIf="isEditMode && !isInactive && !isProtected" type="button"
                            class="kt-btn kt-btn-danger mr-auto" (click)="onInactivate()">
                            <i class="ki-filled ki-cross-circle"></i>
                            Inativar Usu√°rio
                        </button>

                        <button *ngIf="isEditMode && isInactive" type="button" class="kt-btn kt-btn-success mr-auto"
                            (click)="onReactivate()">
                            <i class="ki-filled ki-check-circle"></i>
                            Habilitar Usu√°rio
                        </button>

                        <button type="button" class="kt-btn kt-btn-light" (click)="onCancel()">
                            Cancelar
                        </button>
                        <button type="submit" class="kt-btn kt-btn-primary" [disabled]="form.invalid || loading">
                            <i *ngIf="!loading" class="ki-filled ki-check"></i>
                            <span *ngIf="loading"
                                class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>