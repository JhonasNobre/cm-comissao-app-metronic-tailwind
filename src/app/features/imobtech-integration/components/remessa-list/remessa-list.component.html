<div class="kt-container-fluid">
  <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
    <div class="flex flex-col justify-center gap-2">
      <h1 class="text-xl font-medium leading-none text-mono">
        Remessas Imobtech
      </h1>
      <span class="text-sm text-gray-600">
        Gerencie e acompanhe as remessas de pagamento do Imobtech
      </span>
    </div>
    <div class="flex items-center gap-2.5">
      <button class="kt-btn kt-btn-primary" (click)="onAdd()"
        pTooltip="Abre o formulário para criar uma remessa manual de teste" tooltipPosition="bottom">
        <i class="ki-filled ki-plus"></i>
        Nova Remessa
      </button>
      <button class="kt-btn kt-btn-warning" (click)="abrirReprogramar()"
        pTooltip="Reprograma o vencimento de uma parcela/boleto no sistema Imobtech" tooltipPosition="bottom">
        <i class="ki-filled ki-calendar"></i>
        Reprogramar Vencimento
      </button>
    </div>
  </div>
</div>

<div class="kt-container-fluid">
  <div class="grid gap-5 lg:gap-7.5">
    <app-generic-p-table tableName="remessas-imobtech-list" [tableData]="remessas" [columnDefinition]="columns"
      [rows]="20" [displayCreateAction]="false" [displayDetailAction]="true" [displayEditAction]="false"
      [displayDeleteAction]="false" (detail)="onViewDetails($event)">

      <!-- Custom Actions Template -->
      <ng-template #customActions let-rowData>
        <!-- Botão Reprocessar -->
        <button type="button" class="btn btn-icon btn-sm btn-light-warning" aria-label="Reprocessar"
          pTooltip="Reprocessar" tooltipPosition="top" *ngIf="rowData.statusDescricao === 'Erro'"
          (click)="reprocessar(rowData.id)">
          <i class="ki-filled ki-arrows-circle"></i>
        </button>

        <!-- Botão Cancelar (Remoto) -->
        <button type="button" class="btn btn-icon btn-sm btn-light-warning text-orange-500"
          aria-label="Cancelar na Imobtech" pTooltip="Cancelar na Imobtech" tooltipPosition="top"
          *ngIf="rowData.imobtechRemessaId && rowData.statusDescricao !== 'Cancelado' && rowData.statusDescricao !== 'Processado'"
          (click)="cancelar(rowData)">
          <i class="ki-filled ki-cross-circle"></i>
        </button>

        <!-- Botão Excluir (Local) -->
        <button type="button" class="btn btn-icon btn-sm btn-light-danger" aria-label="Excluir (Local)"
          pTooltip="Excluir (Local)" tooltipPosition="top"
          *ngIf="!rowData.imobtechRemessaId || rowData.statusDescricao === 'Erro'" (click)="excluir(rowData)">
          <i class="ki-filled ki-trash"></i>
        </button>
      </ng-template>

    </app-generic-p-table>
  </div>
</div>

<!-- Modal Detalhes -->
<p-toast></p-toast>
<app-confirm-dialog></app-confirm-dialog>
<p-dialog header="Detalhes da Remessa" [(visible)]="detailVisible" [modal]="true" [style]="{width: '700px'}"
  [draggable]="false" [resizable]="false" appendTo="body">

  <ng-template pTemplate="content">
    <div *ngIf="loadingDetails" class="flex justify-center py-20">
      <i class="pi pi-spin pi-spinner text-primary text-4xl"></i>
    </div>

    <div *ngIf="!loadingDetails && selectedRemessa" class="flex flex-col gap-6 p-2">
      <!-- Cabeçalho de Status -->
      <div class="flex items-center justify-between border-b pb-4">
        <div class="flex flex-col">
          <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">Identificador Imobtech</span>
          <h2 class="text-2xl font-bold text-gray-800">{{ selectedRemessa.imobtechRemessaId || 'Não Gerado' }}</h2>
        </div>
        <div class="flex flex-col items-end">
          <span
            class="kt-badge kt-badge-{{ getStatusSeverity(selectedRemessa.statusDescricao) }} kt-badge-outline rounded-[30px] px-3 py-1">
            <span class="kt-badge-dot size-2"></span>
            <span class="font-semibold">{{ selectedRemessa.statusDescricao }}</span>
          </span>
          <span class="text-[10px] text-gray-500 mt-1 uppercase">Processado em: {{ selectedRemessa.dataProcessamento |
            date:'dd/MM/yyyy HH:mm' }}</span>
        </div>
      </div>

      <!-- Grid de Informações -->
      <div class="grid grid-cols-2 gap-x-8 gap-y-6">
        <div class="flex flex-col">
          <span class="text-xs font-semibold text-gray-500 mb-1">ID Interno do Sistema</span>
          <span class="text-sm font-medium text-gray-700 bg-gray-50 p-2 rounded border border-dashed">{{
            selectedRemessa.id }}</span>
        </div>
        <div class="flex flex-col">
          <span class="text-xs font-semibold text-gray-500 mb-1">ID da Venda (Contrato)</span>
          <span class="text-base font-bold text-primary">#{{ selectedRemessa.idVendaInterna }}</span>
        </div>

        <div class="flex flex-col">
          <span class="text-xs font-semibold text-gray-500 mb-1">Data de Envio</span>
          <div class="flex items-center gap-2">
            <i class="ki-filled ki-calendar text-gray-400"></i>
            <span class="text-sm text-gray-700">{{ selectedRemessa.dataEnvio ? (selectedRemessa.dataEnvio |
              date:'dd/MM/yyyy HH:mm:ss') : 'Aguardando envio' }}</span>
          </div>
        </div>

        <div class="flex flex-col">
          <span class="text-xs font-semibold text-gray-500 mb-1">Valor do Pagamento</span>
          <span class="text-lg font-bold text-green-600">{{ selectedRemessa.valorTotal | currency:'BRL' }}</span>
        </div>
      </div>

      <!-- Seção de Erro (Visualização Premium) -->
      <div *ngIf="selectedRemessa.mensagemErro"
        class="bg-light-danger rounded-xl p-5 border border-dashed border-danger/30">
        <div class="flex items-center gap-3 mb-2">
          <i class="ki-filled ki-information-5 text-danger text-xl"></i>
          <span class="text-sm font-bold text-danger uppercase">Erro no Processamento</span>
        </div>
        <p class="text-sm text-gray-700 leading-relaxed">{{ selectedRemessa.mensagemErro }}</p>
        <div class="mt-3 text-[10px] text-danger/70 font-medium">Tentativas realizadas: {{
          selectedRemessa.tentativasReprocessamento }} de 5</div>
      </div>

      <!-- Placeholder para Rateios (Próxima Fase) -->
      <div class="mt-2 border-t pt-4">
        <button class="btn btn-sm btn-light-primary w-full justify-start" (click)="testarRateios()">
          <i class="ki-filled ki-chart-line-star"></i>
          Ver Extrato de Rateios (Diagnóstico)
        </button>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between w-full">
      <div>
        <button *ngIf="selectedRemessa && selectedRemessa.statusDescricao === 'Erro'" class="btn btn-warning btn-sm"
          (click)="reprocessar(selectedRemessa.id)">
          <i class="ki-filled ki-arrows-circle"></i>
          Forçar Reprocessamento
        </button>
      </div>
      <button class="btn btn-secondary btn-sm" (click)="closeDetailModal()">
        <i class="ki-filled ki-cross"></i>
        Fechar
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Componente Criar Remessa -->
<app-criar-remessa-form></app-criar-remessa-form>

<!-- Modal Reprogramar Vencimento -->
<p-dialog header="Reprogramar Vencimento" [(visible)]="reprogramarVisible" [modal]="true" [style]="{width: '500px'}"
  [draggable]="false" [resizable]="false">

  <ng-template pTemplate="content">
    <div class="flex flex-col gap-4">
      <div>
        <label for="idParcela" class="block text-sm font-semibold text-gray-700 mb-2">
          ID da Parcela
        </label>
        <input id="idParcela" type="number" pInputText [(ngModel)]="idParcelaInput" placeholder="Ex: 12345"
          class="w-full" />
        <small class="text-gray-500">Digite o ID interno da parcela que deseja reprogramar</small>
      </div>

      <div>
        <label for="novaData" class="block text-sm font-semibold text-gray-700 mb-2">
          Nova Data de Vencimento
        </label>
        <input id="novaData" type="date" pInputText [(ngModel)]="novaDataVencimento" class="w-full" />
        <small class="text-gray-500">Selecione a nova data de vencimento</small>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded p-3">
        <div class="flex gap-2">
          <i class="pi pi-info-circle text-blue-600"></i>
          <p class="text-sm text-blue-700">
            Esta operação altera a data de vencimento do boleto/parcela no Imobtech.
          </p>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="fecharReprogramar()"></button>
    <button pButton label="Confirmar" icon="pi pi-check" class="p-button-warning" [loading]="reprogramandoLoading"
      [disabled]="!idParcelaInput || !novaDataVencimento" (click)="confirmarReprogramar()"></button>
  </ng-template>
</p-dialog>