<div class="kt-container-fluid">
    <div class="card card-custom gutter-b">
        <div class="card-header border-0 py-5">
            <h3 class="card-title text-2xl font-bold text-gray-800 dark:text-gray-100">
                <span class="card-label font-weight-bolder">Vendas Importadas</span>
                <small class="block text-sm text-gray-500 mt-1">Vendas importadas aguardando cálculo de comissão</small>
            </h3>
        </div>

        <div class="card-body py-0">
            <app-generic-p-table tableName="vendas-importadas" [tableData]="vendas" [columnDefinition]="columns"
                [totalRecords]="totalRecords" [rows]="filtros.tamanhoPagina" [serverSidePagination]="true"
                [displayCreateAction]="false" [displayDetailAction]="false" [displayEditAction]="false"
                [displayDeleteAction]="false" (lazyLoad)="onLazyLoad($event)">

                <ng-template #customActions let-venda>
                    <button pButton pRipple label="Calcular" icon="pi pi-calculator"
                        class="p-button-success p-button-sm" (click)="abrirGerar(venda)">
                    </button>
                </ng-template>

            </app-generic-p-table>
        </div>
    </div>
</div>

<p-toast></p-toast>

<!-- Dialog Gerar Comissão -->
<p-dialog header="Gerar Comissão" [(visible)]="gerarVisible" [modal]="true" [style]="{width: '450px'}"
    [draggable]="false" [resizable]="false">
    <ng-template pTemplate="content">
        <div class="flex flex-col gap-4 py-2" *ngIf="vendaSelecionada">
            <div class="bg-gray-50 p-3 rounded border">
                <p class="font-medium text-gray-900">{{ vendaSelecionada.nomeCliente || 'Cliente N/A' }}</p>
                <div class="flex justify-between mt-1">
                    <span class="text-xs text-gray-500">Código: {{ vendaSelecionada.idVendaLegado }}</span>
                    <span class="font-bold text-primary">{{ vendaSelecionada.valorTotalVenda | currency:'BRL' }}</span>
                </div>
            </div>

            @if (semEstruturaVinculada) {
            <div class="p-3 bg-amber-50 rounded border border-amber-200 flex items-start gap-2">
                <i class="pi pi-exclamation-triangle text-amber-500 mt-0.5 flex-shrink-0"></i>
                <p class="text-sm text-amber-800">
                    Esta venda não possui uma estrutura de comissão vinculada. Vincule uma estrutura antes de gerar a comissão.
                </p>
            </div>
            } @else {
            <div class="p-3 bg-green-50 rounded border border-green-100 flex items-center gap-2">
                <i class="pi pi-check-circle text-green-600 flex-shrink-0"></i>
                <p class="text-sm text-green-800">Estrutura de comissão vinculada. Clique em <strong>Confirmar e Gerar</strong> para continuar.</p>
            </div>
            }
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="gerarVisible = false"></button>
        <button pButton label="Confirmar e Gerar" icon="pi pi-check" class="p-button-success"
            (click)="confirmarGeracao()" [loading]="gerando" [disabled]="semEstruturaVinculada"></button>
    </ng-template>
</p-dialog>
