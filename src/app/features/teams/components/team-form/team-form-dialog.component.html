<form [formGroup]="form" class="flex flex-col h-full">
    <!-- Área de conteúdo rolável -->
    <div class="flex-1 overflow-y-auto pr-2 flex flex-col gap-5">

        <!-- Nome da Equipe -->
        <div class="flex flex-col gap-2">
            <label for="nome" class="font-semibold text-gray-700">{{ 'teams.form.name' | transloco }}</label>
            <input pInputText id="nome" formControlName="nome" placeholder="{{ 'teams.form.name' | transloco }}"
                class="w-full" />
            <small *ngIf="form.get('nome')?.invalid && form.get('nome')?.touched" class="text-red-500">
                {{ 'general.validation.required' | transloco }}
            </small>
        </div>

        <!-- Descrição da Equipe -->
        <div class="flex flex-col gap-2">
            <label for="descricao" class="font-semibold text-gray-700">Descrição</label>
            <textarea pTextarea id="descricao" formControlName="descricao" [rows]="3" class="w-full"
                placeholder="Descreva a equipe (opcional)"></textarea>
        </div>

        <!-- Grupo de Equipe (Com suporte a cor) -->
        <div class="flex flex-col gap-2">
            <label for="grupo" class="font-semibold text-gray-700">Grupo de Equipe</label>
            <p-select [options]="teamGroups" formControlName="grupoEquipeId" optionLabel="nome" optionValue="id"
                placeholder="Selecione um grupo (Opcional)" styleClass="w-full" [style]="{'width':'100%'}"
                appendTo="body">
                <ng-template let-item pTemplate="item">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full" [style.backgroundColor]="item.cor || '#ccc'"></span>
                        <span>{{ item.nome }}</span>
                    </div>
                </ng-template>
                <ng-template let-selectedOption pTemplate="selectedItem">
                    <div class="flex items-center gap-2" *ngIf="selectedOption">
                        <span class="w-3 h-3 rounded-full"
                            [style.backgroundColor]="selectedOption.cor || '#ccc'"></span>
                        <span>{{ selectedOption.nome }}</span>
                    </div>
                    <span *ngIf="!selectedOption">Selecione um grupo (Opcional)</span>
                </ng-template>
            </p-select>
        </div>

        <!-- Perfil de Acesso -->
        <div class="flex flex-col gap-2">
            <label for="perfil" class="font-semibold text-gray-700">{{ 'teams.form.access_profile' | transloco
                }}</label>
            <p-select [options]="accessProfiles" formControlName="perfilAcessoId" optionLabel="nome" optionValue="id"
                placeholder="{{ 'teams.form.select_profile' | transloco }}" styleClass="w-full"
                [style]="{'width':'100%'}" appendTo="body"></p-select>
        </div>

        <p-divider></p-divider>

        <!-- Checkbox de Restrição de Horário -->
        <div class="flex items-center gap-2" formGroupName="restricaoHorario">
            <p-checkbox [binary]="true" inputId="restricao" formControlName="ativo"
                (onChange)="toggleRestricaoHorario($event)"></p-checkbox>
            <label for="restricao" class="font-semibold cursor-pointer select-none text-gray-700">
                {{ 'teams.form.time_restriction' | transloco }}
            </label>
        </div>

        <!-- Painel de Configuração de Restrição -->
        <div *ngIf="hasRestricaoHorario" formGroupName="restricaoHorario"
            class="flex flex-col gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">

            <!-- Feriados e Recessos Section -->
            <div class="flex flex-col gap-3 border-b pb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-800">Feriados e Recessos</h3>
                        <p class="text-xs text-gray-500 mt-0.5">Selecione os feriados que a equipe terá o acesso do
                            sistema interrompido.</p>
                    </div>
                </div>

                <!-- Toggle to show National Holidays -->
                <div class="flex items-center gap-2">
                    <p-checkbox [binary]="true" inputId="showNationalHolidays" [(ngModel)]="showNationalHolidays"
                        [ngModelOptions]="{standalone: true}" (onChange)="toggleShowNationalHolidays()"></p-checkbox>
                    <label for="showNationalHolidays" class="cursor-pointer select-none font-medium">
                        Feriados Nacionais
                    </label>
                </div>

                <!-- National Holidays List -->
                <div *ngIf="showNationalHolidays" class="ml-6 flex flex-col gap-2 border-l-2 border-gray-200 pl-4">
                    <!-- Master Checkbox -->
                    <div class="flex items-center gap-2">
                        <p-checkbox [binary]="true" inputId="allNationalHolidays"
                            [(ngModel)]="allNationalHolidaysSelected" [ngModelOptions]="{standalone: true}"
                            (onChange)="toggleAllNationalHolidays($event.checked)"></p-checkbox>
                        <label for="allNationalHolidays"
                            class="cursor-pointer select-none text-sm font-medium text-primary">
                            Selecionar Todos os Feriados Nacionais
                        </label>
                    </div>

                    <!-- Individual National Holidays -->
                    <div *ngIf="nationalHolidays.length > 0" class="flex flex-col gap-1.5 mt-2">
                        <div *ngFor="let holiday of nationalHolidays" class="flex items-center gap-2">
                            <p-checkbox [binary]="true" [inputId]="'holiday-' + holiday.id"
                                [ngModel]="isHolidaySelected(holiday.id)" [ngModelOptions]="{standalone: true}"
                                (onChange)="toggleHoliday(holiday.id, $event.checked)"></p-checkbox>
                            <label [for]="'holiday-' + holiday.id" class="cursor-pointer select-none text-sm">
                                {{ holiday.nome }} ({{ holiday.data | date: 'dd/MM' }})
                            </label>
                        </div>
                    </div>

                    <div *ngIf="nationalHolidays.length === 0" class="text-xs text-gray-500 italic">
                        Carregando feriados nacionais...
                    </div>
                </div>

                <!-- State/City Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div class="flex flex-col gap-2">
                        <label for="estadoId" class="text-sm font-medium text-gray-600">Estado</label>
                        <p-select formControlName="estadoId" placeholder="Selecione o estado" [options]="states"
                            optionLabel="nome" optionValue="id" [showClear]="true" [filter]="true" filterBy="nome"
                            appendTo="body" styleClass="w-full" [style]="{'width':'100%'}">
                        </p-select>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="municipioId" class="text-sm font-medium text-gray-600">Cidade</label>
                        <p-select formControlName="municipioId" placeholder="Selecione a cidade" [options]="cities"
                            optionLabel="nome" optionValue="id" [showClear]="true" [filter]="true" filterBy="nome"
                            appendTo="body" styleClass="w-full" [style]="{'width':'100%'}">
                        </p-select>
                    </div>
                </div>

                <!-- Regional Holidays List -->
                <div *ngIf="regionalHolidays.length > 0"
                    class="ml-6 flex flex-col gap-2 border-l-2 border-gray-200 pl-4 mt-2">
                    <h4 class="text-sm font-semibold text-gray-700">Feriados Regionais</h4>
                    <div class="flex flex-col gap-1.5">
                        <div *ngFor="let holiday of regionalHolidays" class="flex items-center gap-2">
                            <p-checkbox [binary]="true" [inputId]="'regional-' + holiday.id"
                                [ngModel]="isHolidaySelected(holiday.id)" [ngModelOptions]="{standalone: true}"
                                (onChange)="toggleHoliday(holiday.id, $event.checked)"></p-checkbox>
                            <label [for]="'regional-' + holiday.id" class="cursor-pointer select-none text-sm">
                                {{ holiday.nome }} ({{ holiday.data | date: 'dd/MM' }}) - {{ holiday.tipo }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Horários -->
            <div class="flex flex-col gap-3 mt-2">
                <div class="flex justify-between items-center">
                    <label class="font-semibold text-gray-700">{{ 'teams.form.allowed_times' | transloco }}</label>
                    <button type="button" class="kt-btn kt-btn-sm kt-btn-light-primary" (click)="addHorario()">
                        <i class="ki-filled ki-plus"></i>
                        {{ 'teams.form.add_time' | transloco }}
                    </button>
                </div>

                <div formArrayName="horarios" class="flex flex-col gap-3">
                    <div *ngFor="let item of horarios.controls; let i = index" [formGroupName]="i"
                        class="flex flex-wrap md:flex-nowrap gap-2 items-end bg-white p-3 rounded border border-gray-200 shadow-sm">

                        <!-- Dia da Semana -->
                        <div class="w-full md:flex-1">
                            <label class="text-xs text-gray-500 block mb-1">{{ 'teams.form.day' | transloco }}</label>
                            <p-select [options]="diasSemanaOptions" formControlName="diaSemana" optionLabel="label"
                                optionValue="value" styleClass="w-full" [style]="{'width':'100%'}"
                                appendTo="body"></p-select>
                        </div>

                        <!-- Hora Início -->
                        <div class="w-1/2 md:w-28">
                            <label class="text-xs text-gray-500 block mb-1">{{ 'teams.form.start' | transloco }}</label>
                            <p-inputMask mask="99:99" formControlName="horaInicio" placeholder="00:00"
                                styleClass="w-full"></p-inputMask>
                        </div>

                        <!-- Hora Fim -->
                        <div class="w-1/2 md:w-28">
                            <label class="text-xs text-gray-500 block mb-1">{{ 'teams.form.end' | transloco }}</label>
                            <p-inputMask mask="99:99" formControlName="horaFim" placeholder="00:00"
                                styleClass="w-full"></p-inputMask>
                        </div>

                        <!-- Botão Remover -->
                        <button type="button" class="btn btn-icon btn-light-danger" pTooltip="Remover"
                            tooltipPosition="top" (click)="removeHorario(i)">
                            <i class="ki-filled ki-trash"></i>
                        </button>
                    </div>

                    <div *ngIf="horarios.controls.length === 0" class="text-center p-4 text-gray-500 text-sm italic">
                        Nenhum horário configurado. Adicione um horário para permitir acesso.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Gestão de Integrantes -->
    <div class="flex-1 overflow-y-auto pr-2 flex flex-col gap-5 mt-4" *ngIf="form.get('id')?.value">
        <p-divider></p-divider>

        <h3 class="font-semibold text-lg text-gray-800">Administrar Integrantes da Equipe</h3>

        <!-- Adicionar Membro -->
        <div class="flex gap-2">
            <div class="flex-1">
                <input pInputText placeholder="Insira o e-mail do usuário..." class="w-full" #emailInput />
            </div>
            <button pButton type="button" label="Adicionar" icon="pi pi-plus" class="p-button-primary"
                (click)="onAddMember(emailInput.value); emailInput.value=''"></button>
        </div>

        <!-- Lista de Membros -->
        <div class="border rounded-lg overflow-hidden mt-2" *ngIf="members.length > 0">
            <p-table [value]="members" [rowHover]="true" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th class="text-sm font-semibold text-gray-600 bg-gray-50 p-2">Nome</th>
                        <th class="text-sm font-semibold text-gray-600 bg-gray-50 p-2">Email</th>
                        <th class="text-sm font-semibold text-gray-600 bg-gray-50 p-2">Perfil</th>
                        <th class="text-sm font-semibold text-gray-600 bg-gray-50 p-2 text-center w-16">Ações</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-member>
                    <tr class="border-b last:border-0 border-gray-100">
                        <td class="p-2 text-sm text-gray-700">{{ member.nome }}</td>
                        <td class="p-2 text-sm text-gray-500">{{ member.email }}</td>
                        <td class="p-2">
                            <span
                                class="px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                {{ member.perfilNome || 'N/A' }}
                            </span>
                        </td>
                        <td class="p-2 text-center">
                            <button type="button" class="btn btn-icon btn-light-danger btn-sm w-7 h-7"
                                (click)="onRemoveMember(member)" pTooltip="Remover membro" tooltipPosition="left">
                                <i class="ki-filled ki-trash fs-6"></i>
                            </button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <div *ngIf="members.length === 0"
            class="text-gray-500 text-sm italic text-center py-6 border border-dashed border-gray-300 rounded-lg bg-gray-50 mt-2">
            Nenhum membro vinculado a esta equipe.
        </div>
    </div>

    <!-- Rodapé com Ações (Fixo) -->
    <div class="flex justify-end gap-3 pt-5 mt-4 border-t border-gray-200">
        <button type="button" class="kt-btn kt-btn-light" (click)="onCancel()">
            {{ 'SHARED.COMMON.CANCEL' | transloco }}
        </button>
        <button type="button" class="kt-btn kt-btn-primary" (click)="onSubmit()">
            <i class="ki-filled ki-check"></i>
            {{ 'general.singular.save' | transloco }}
        </button>
    </div>
</form>